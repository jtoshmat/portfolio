(function(c){function l(a,b){return new l.prototype.init(a,b)}var p=0,m=!1;"use strict";var n=function(a){this[0]=a.startOffset;this[1]=a.endOffset;this.range=a;return this};n.prototype.equals=function(){return this[0]===this[1]};c.fn.redactor=function(a){var b=[],d=Array.prototype.slice.call(arguments,1);"string"===typeof a?this.each(function(){var e=c.data(this,"redactor");if("undefined"!==typeof e&&c.isFunction(e[a])){var g=e[a].apply(e,d);void 0!==g&&g!==e&&b.push(g)}else return c.error('No such method "'+
a+'" for Redactor')}):this.each(function(){c.data(this,"redactor")||c.data(this,"redactor",l(this,a))});return 0===b.length?this:1===b.length?b[0]:b};c.Redactor=l;c.Redactor.VERSION="9.0.1";c.Redactor.opts={initCallback:!1,changeCallback:!1,focusCallback:!1,blurCallback:!1,keydownCallback:!1,keyupCallback:!1,execCommandCallback:!1,pasteBeforeCallback:!1,pasteAfterCallback:!1,autosaveCallback:!1,imageUploadCallback:!1,imageUploadErrorCallback:!1,imageDeleteCallback:!1,fileUploadCallback:!1,fileUploadErrorCallback:!1,
rangy:!1,iframe:!1,fullpage:!1,css:!1,lang:"en",direction:"ltr",placeholder:!1,wym:!1,mobile:!0,cleanup:!0,visual:!0,focus:!1,tabindex:!1,autoresize:!0,minHeight:!1,shortcuts:!0,autosave:!1,autosaveInterval:60,plugins:!1,linkAnchor:!1,linkEmail:!1,linkProtocol:"http://",imageGetJson:!1,imageUpload:!1,fileUpload:!1,s3:!1,uploadFields:!1,observeImages:!0,modalOverlay:!0,tabFocus:!0,air:!1,airButtons:"formatting | bold italic deleted | unorderedlist orderedlist outdent indent | fontcolor backcolor".split(" "),
toolbar:!0,toolbarFixed:!1,toolbarFixedTopOffset:0,toolbarFixedBox:!1,toolbarExternal:!1,buttonSource:!0,buttonSeparator:'<li class="redactor_separator"></li>',buttonsCustom:{},buttonsAdd:[],buttons:"html | formatting | bold italic deleted | unorderedlist orderedlist outdent indent | image video file table link | fontcolor backcolor | alignment | horizontalrule".split(" "),colors:"#ffffff #000000 #eeece1 #1f497d #4f81bd #c0504d #9bbb59 #8064a2 #4bacc6 #f79646 #ffff00 #f2f2f2 #7f7f7f #ddd9c3 #c6d9f0 #dbe5f1 #f2dcdb #ebf1dd #e5e0ec #dbeef3 #fdeada #fff2ca #d8d8d8 #595959 #c4bd97 #8db3e2 #b8cce4 #e5b9b7 #d7e3bc #ccc1d9 #b7dde8 #fbd5b5 #ffe694 #bfbfbf #3f3f3f #938953 #548dd4 #95b3d7 #d99694 #c3d69b #b2a2c7 #b7dde8 #fac08f #f2c314 #a5a5a5 #262626 #494429 #17365d #366092 #953734 #76923c #5f497a #92cddc #e36c09 #c09100 #7f7f7f #0c0c0c #1d1b10 #0f243e #244061 #632423 #4f6128 #3f3151 #31859b #974806 #7f6000".split(" "),
activeButtons:"deleted italic bold underline unorderedlist orderedlist alignleft aligncenter alignright justify table".split(" "),activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},activeButtonsAdd:!1,formattingTags:"p blockquote pre h1 h2 h3 h4".split(" "),linebreaks:!1,paragraphy:!0,convertDivs:!0,convertLinks:!0,formattingPre:!1,phpTags:!1,allowedTags:!1,deniedTags:"html head link body meta script style applet".split(" "),
boldTag:"strong",italicTag:"em",buffer:[],rebuffer:[],textareamode:!1,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:"H1 H2 H3 H4 H5 H6 P TD DIV BLOCKQUOTE".split(" "),ownLine:"area body head hr i?frame link meta noscript style script table tbody thead tfoot".split(" "),contOwnLine:"li dt dt h[1-6] option script".split(" "),newLevel:"blockquote div dl fieldset form frameset map ol p pre select td th tr ul".split(" "),
blockLevelElements:"P H1 H2 H3 H4 H5 H6 DD DL DT DIV LI BLOCKQUOTE OUTPUT FIGCAPTION PRE ADDRESS SECTION HEADER FOOTER ASIDE ARTICLE".split(" "),langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",bold:"Bold",italic:"Italic",fontcolor:"Font Color",
backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",
title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",
link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)"}}};l.fn=c.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(a,b){this.$element=this.$source=c(a);this.uuid=p++;this.opts=c.extend({},c.Redactor.opts,this.$element.data(),b);this.start=!0;this.dropdowns=[];this.sourceHeight=this.$source.css("height");this.sourceWidth=this.$source.css("width");this.opts.fullpage&&
(this.opts.iframe=!0);this.opts.linebreaks&&(this.opts.paragraphy=!1);this.opts.paragraphy&&(this.opts.linebreaks=!1);this.opts.toolbarFixedBox&&(this.opts.toolbarFixed=!0);this.document=document;this.window=window;this.savedSel=!1;this.cleanlineBefore=RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]");this.cleanlineAfter=RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+")[ >]");this.cleannewLevel=RegExp("^</?("+this.opts.newLevel.join("|")+
")[ >]");this.rTestBlock=RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");if(!1===this.opts.linebreaks&&(!1!==this.opts.allowedTags&&"-1"===c.inArray("p",this.opts.allowedTags)&&this.opts.allowedTags.push("p"),!1!==this.opts.deniedTags)){var d=c.inArray("p",this.opts.deniedTags);"-1"!==d&&this.opts.deniedTags.splice(d,d)}if(this.browser("msie")||this.browser("opera"))this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,"horizontalrule");this.opts.curLang=this.opts.langs[this.opts.lang];
this.buildStart()},initToolbar:function(a){return{html:{title:a.html,func:"toggle"},formatting:{title:a.formatting,func:"show",dropdown:{p:{title:a.paragraph,func:"formatBlocks"},blockquote:{title:a.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:a.code,func:"formatBlocks",className:"redactor_format_pre"},h1:{title:a.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:a.header2,func:"formatBlocks",className:"redactor_format_h2"},h3:{title:a.header3,func:"formatBlocks",
className:"redactor_format_h3"},h4:{title:a.header4,func:"formatBlocks",className:"redactor_format_h4"}}},bold:{title:a.bold,exec:"bold"},italic:{title:a.italic,exec:"italic"},deleted:{title:a.deleted,exec:"strikethrough"},underline:{title:a.underline,exec:"underline"},unorderedlist:{title:"&bull; "+a.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+a.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+a.outdent,func:"indentingOutdent"},indent:{title:"> "+a.indent,func:"indentingIndent"},
image:{title:a.image,func:"imageShow"},video:{title:a.video,func:"videoShow"},file:{title:a.file,func:"fileShow"},table:{title:a.table,func:"show",dropdown:{insert_table:{title:a.insert_table,func:"tableShow"},separator_drop1:{name:"separator"},insert_row_above:{title:a.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:a.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:a.insert_column_left,func:"tableAddColumnLeft"},insert_column_right:{title:a.insert_column_right,
func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:a.add_head,func:"tableAddHead"},delete_head:{title:a.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:a.delete_column,func:"tableDeleteColumn"},delete_row:{title:a.delete_row,func:"tableDeleteRow"},delete_table:{title:a.delete_table,func:"tableDeleteTable"}}},link:{title:a.link,func:"show",dropdown:{link:{title:a.link_insert,func:"linkShow"},unlink:{title:a.unlink,exec:"unlink"}}},
fontcolor:{title:a.fontcolor,func:"show"},backcolor:{title:a.backcolor,func:"show"},alignment:{title:a.alignment,func:"show",dropdown:{alignleft:{title:a.align_left,func:"alignmentLeft"},aligncenter:{title:a.align_center,func:"alignmentCenter"},alignright:{title:a.align_right,func:"alignmentRight"},justify:{title:a.align_justify,func:"alignmentJustify"}}},alignleft:{title:a.align_left,func:"alignmentLeft"},aligncenter:{title:a.align_center,func:"alignmentCenter"},alignright:{title:a.align_right,func:"alignmentRight"},
justify:{title:a.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:a.horizontalrule}}},callback:function(a,b,d){a=this.opts[a+"Callback"];return c.isFunction(a)?!1===b?a.call(this,d):a.call(this,b,d):d},destroy:function(){clearInterval(this.autosaveInterval);c(window).off(".redactor");this.$element.off(".redactor").removeData("redactor");var a=this.get();if(this.opts.textareamode)this.$box.after(this.$source),this.$box.remove(),this.$source.val(a).show();else{var b=
this.$editor;this.opts.iframe&&(b=this.$element);this.$box.after(b);this.$box.remove();b.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(a).show()}},getObject:function(){return c.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return this.opts.iframe?this.$frame:!1},getToolbar:function(){return this.$toolbar},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");
var a=this.outerHtml(this.$frame.contents().children());this.$editor.attr({contenteditable:!0,dir:this.opts.direction});return a},set:function(a,b){a=a.toString();this.opts.fullpage?this.setCodeIframe(a):this.setEditor(a,b)},setEditor:function(a,b){!1!==b&&(a=this.cleanSavePreCode(a),a=this.cleanStripTags(a),a=this.cleanConvertProtected(a),a=this.cleanConvertInlineTags(a),a=!1===this.opts.linebreaks?this.cleanConverters(a):a.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>"));a=this.cleanEmpty(a);this.$editor.html(a);
this.sync()},setCodeIframe:function(a){var b=this.iframePage();this.$frame[0].src="about:blank";a=this.cleanConvertProtected(a);a=this.cleanConvertInlineTags(a);a=this.cleanRemoveSpaces(a);b.open();b.write(a);b.close();this.opts.fullpage&&(this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction}));this.sync()},setFullpageOnInit:function(a){a=this.cleanSavePreCode(a,!0);a=this.cleanConverters(a);a=this.cleanEmpty(a);this.$editor.html(a);this.sync()},sync:function(){var a=
"";this.cleanUnverified();a=this.opts.fullpage?this.getCodeIframe():this.$editor.html();a=this.syncClean(a);a=this.cleanRemoveSpaces(a);a=this.cleanRemoveEmptyTags(a);a=a.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>");"<br>"===c.trim(a)&&(a="");""!==a&&(a=this.cleanHtml(a));a=this.callback("syncBefore",!1,a);this.$source.val(a);"undefined"!=typeof htmlEncode&&c("#"+this.$element[0].id+"_code").html(htmlEncode(a));this.callback("syncAfter",!1,a);!1===this.start&&this.callback("change",
!1,a)},syncClean:function(a){this.opts.fullpage||(a=this.cleanStripTags(a));a=c.trim(a);a=this.placeholderRemoveFromCode(a);a=a.replace(/&#x200b;/gi,"");a=a.replace(/&#8203;/gi,"");a=a.replace(/&nbsp;/gi," ");a=a.replace("\x3c!--?php","<?php");a=a.replace("?--\x3e","?>");a=a.replace(/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi,'<font$1data-redactor="verified"$2>$3</font>');a=a.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");a=a.replace(/<font(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/font>/gi,
"<span$1$2>$3</span>");a=a.replace(/<br\s?\/?>\n?<\/(.*?)>/gi,"</$1>");a=a.replace(/<span(.*?)data-redactor-inlineMethods=""(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>");a=a.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1");a=a.replace(/<span\s*?id="selection-marker(.*?)"(.*?)>([\w\W]*?)<\/span>/gi,"");return a=this.cleanReConvertProtected(a)},buildStart:function(){this.content="";this.$box=c('<div class="redactor_box" />');"TEXTAREA"===this.$source[0].tagName&&(this.opts.textareamode=!0);!1===
this.opts.mobile&&this.isMobile()?this.buildMobile():(this.buildContent(),this.opts.iframe?(this.opts.autoresize=!1,this.iframeStart()):this.opts.textareamode?this.buildFromTextarea():this.buildFromElement(),this.opts.iframe||(this.buildOptions(),this.buildAfter()))},buildMobile:function(){this.opts.textareamode||(this.$editor=this.$source,this.$editor.hide(),this.$source=this.buildCodearea(this.$editor),this.$source.val(this.content));this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){this.content=
this.opts.textareamode?c.trim(this.$source.val()):c.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=c("<div />");this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);this.buildAddClasses(this.$editor);this.buildEnable()},buildFromElement:function(){this.$editor=this.$source;this.$source=this.buildCodearea(this.$editor);this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);this.buildEnable()},buildCodearea:function(a){return c("<textarea />").attr("name",
a.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(a){c.each(this.$source.get(0).className.split(/\s+/),function(b,c){a.addClass("redactor_"+c)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:!0,dir:this.opts.direction});this.$source.attr("dir",this.opts.direction).hide();this.set(this.content)},buildOptions:function(){var a=this.$editor;this.opts.iframe&&(a=this.$frame);this.opts.tabindex&&a.attr("tabindex",this.opts.tabindex);this.opts.minHeight&&
a.css("min-height",this.opts.minHeight+"px");this.opts.wym&&this.$editor.addClass("redactor_editor_wym");this.opts.autoresize||a.css("height",this.sourceHeight)},buildAfter:function(){this.start=!1;this.opts.toolbar&&(this.opts.toolbar=this.initToolbar(this.opts.curLang),this.toolbarBuild());this.modalTemplatesInit();this.buildPlugins();this.buildBindKeyboard();this.opts.autosave&&this.autosave();setTimeout(c.proxy(this.observeStart,this),4);if(this.browser("mozilla"))try{this.document.execCommand("enableObjectResizing",
!1,!1),this.document.execCommand("enableInlineTableEditing",!1,!1)}catch(a){}this.opts.focus&&setTimeout(c.proxy(this.focus,this),100);this.opts.visual||setTimeout(c.proxy(function(){this.opts.visual=!0;this.toggle(!1)},this),200);this.callback("init")},buildBindKeyboard:function(){var a=!1;this.browser("webkit")&&-1===navigator.userAgent.indexOf("Chrome")&&536>this.browser("version").split(".")[0]&&(a=!0);this.$editor.on("paste.redactor",c.proxy(function(){if(a||this.browser("opera"))return!0;if(this.isMobile()||
!this.opts.cleanup)return!1;m=!0;this.selectionSave();this.selectall||(!0===this.opts.autoresize?(this.$editor.height(this.$editor.height()),this.saveScroll=this.document.body.scrollTop):this.saveScroll=this.$editor.scrollTop());var b=this.extractContent();setTimeout(c.proxy(function(){var a=this.extractContent();this.$editor.append(b);this.selectionRestore();a=this.getFragmentHtml(a);this.pasteClean(a);!0===this.opts.autoresize&&this.$editor.css("height","auto")},this),1)},this));this.$editor.on("keydown.redactor",
c.proxy(function(a){if(m)return!1;var d=a.which,e=a.ctrlKey||a.metaKey,g=this.getParent(),f=this.getCurrent(),h=this.getBlock(),j=!1;this.callback("keydown",a);if(g&&"PRE"===c(g).get(0).tagName||f&&"PRE"===c(f).get(0).tagName)j=!0,d===this.keyCode.DOWN&&this.insertAfterLastElement(h);d===this.keyCode.DOWN&&(g&&"BLOCKQUOTE"===c(g).get(0).tagName&&this.insertAfterLastElement(g),f&&"BLOCKQUOTE"===c(f).get(0).tagName&&this.insertAfterLastElement(f));e&&!a.shiftKey&&this.shortcuts(a,d);if(e&&90===d&&!a.shiftKey&&
!a.altKey)a.preventDefault(),this.opts.buffer.length?this.bufferUndo():this.document.execCommand("undo",!1,!1);else if(e&&90===d&&a.shiftKey&&!a.altKey)a.preventDefault(),0!=this.opts.rebuffer.length?this.bufferRedo():this.document.execCommand("redo",!1,!1);else{e&&65===d?this.selectall=!0:d!=this.keyCode.LEFT_WIN&&!e&&(this.selectall=!1);if(d==this.keyCode.ENTER&&!a.shiftKey&&!a.ctrlKey&&!a.metaKey){if(1==g.nodeType&&("TD"==g.tagName||"TH"==g.tagName))return this.bufferSet(),this.insertNode(document.createElement("br")),
a.preventDefault(),!1;if(!0===j)return this.bufferSet(),a.preventDefault(),f=c(f).parent().text(),this.insertNode(document.createTextNode("\n")),-1==f.search(/\s$/)&&this.insertNode(document.createTextNode("\n")),this.sync(),!1;if(!this.opts.linebreaks)if(h&&this.opts.rBlockTest.test(h.tagName))this.bufferSet(),setTimeout(c.proxy(function(){var a=this.getBlock();if("DIV"===a.tagName&&!c(a).hasClass("redactor_editor")){var b=c("<p>"+this.opts.invisibleSpace+"</p>");c(a).replaceWith(b);this.selectionStart(b)}},
this),1);else if(!1===h)return this.bufferSet(),f=c("<p>"+this.opts.invisibleSpace+"</p>"),this.insertNode(f[0]),this.selectionStart(f),!1;if(this.opts.linebreaks)if(h&&this.opts.rBlockTest.test(h.tagName))this.bufferSet(),setTimeout(c.proxy(function(){var a=this.getBlock();("DIV"===a.tagName||"P"===a.tagName)&&!c(a).hasClass("redactor_editor")&&this.replaceLineBreak(a)},this),1);else{this.bufferSet();this.insertLineBreak();a.preventDefault();return}if("BLOCKQUOTE"==h.tagName||"FIGCAPTION"==h.tagName){this.bufferSet();
this.insertLineBreak();a.preventDefault();return}}else if(d===this.keyCode.ENTER&&(a.ctrlKey||a.shiftKey))this.bufferSet(),a.preventDefault(),this.insertLineBreak();if(d===this.keyCode.TAB&&this.opts.shortcuts){if(!this.opts.tabFocus||this.isEmpty(this.get()))return!0;a.preventDefault();!0===j&&!a.shiftKey?(this.bufferSet(),this.insertNode(document.createTextNode("\t")),this.sync()):a.shiftKey?this.indentingOutdent():this.indentingIndent();return!1}d===this.keyCode.BACKSPACE&&("undefined"!==typeof f.nodeValue&&
null!==f.nodeValue)&&(a=c.trim(f.nodeValue.replace(/[^\u0000-~]/g,"")),f.remove&&(3===f.nodeType&&8203==f.nodeValue.charCodeAt(0)&&""==a)&&f.remove())}},this));this.$editor.on("keyup.redactor",c.proxy(function(a){if(m)return!1;var d=a.which,e=this.getParent(),g=this.getCurrent();if(!this.opts.linebreaks&&3==g.nodeType&&(!1==e||"BODY"==e.tagName))e=c("<p>").append(c(g).clone()),c(g).replaceWith(e),g=c(e).next(),"BR"==g[0].tagName&&g.remove(),this.selectionEnd(e);this.opts.convertLinks&&d===this.keyCode.ENTER&&
this.formatLinkify(this.opts.linkProtocol);if(!1===this.opts.linebreaks&&(d===this.keyCode.DELETE||d===this.keyCode.BACKSPACE))return this.formatEmpty(a);this.callback("keyup",a);this.sync()},this));if(c.isFunction(this.opts.focusCallback))this.$editor.on("focus.redactor",c.proxy(this.opts.focusCallback,this));if(c.isFunction(this.opts.blurCallback))this.$editor.on("blur.redactor",c.proxy(this.opts.blurCallback,this))},buildPlugins:function(){this.opts.plugins&&c.each(this.opts.plugins,c.proxy(function(a,
b){RedactorPlugins[b]&&(c.extend(this,RedactorPlugins[b]),c.isFunction(RedactorPlugins[b].init)&&this.init())},this))},iframeStart:function(){this.iframeCreate();this.opts.textareamode?this.iframeAppend(this.$source):(this.$sourceOld=this.$source.hide(),this.$source=this.buildCodearea(this.$sourceOld),this.iframeAppend(this.$sourceOld))},iframeAppend:function(a){this.$source.attr("dir",this.opts.direction).hide();this.$box.insertAfter(a).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=
c('<iframe style="width: 100%;" frameborder="0" />').one("load",c.proxy(function(){if(this.opts.fullpage){this.iframePage();""===this.content&&(this.content=this.opts.invisibleSpace);this.$frame.contents()[0].write(this.content);this.$frame.contents()[0].close();var a=setInterval(c.proxy(function(){this.$frame.contents().find("body").html()&&(clearInterval(a),this.iframeLoad())},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var a=
this.iframeDoc();a.documentElement&&a.removeChild(a.documentElement);return a},iframeAddCss:function(a){a=a||this.opts.css;this.isString(a)&&this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+a+'" />');c.isArray(a)&&c.each(a,c.proxy(function(a,c){this.iframeAddCss(c)},this))},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction});this.$editor[0]&&(this.document=this.$editor[0].ownerDocument,this.window=this.document.defaultView||
window);this.iframeAddCss();this.opts.fullpage?this.setFullpageOnInit(this.$editor.html()):this.set(this.content);this.buildOptions();this.buildAfter()},placeholderStart:function(a){return this.isEmpty(a)&&(this.$element.attr("placeholder")&&(this.opts.placeholder=this.$element.attr("placeholder")),""===this.opts.placeholder&&(this.opts.placeholder=!1),!1!==this.opts.placeholder)?(this.opts.focus=!1,this.$editor.one("focus.redactor_placeholder",c.proxy(this.placeholderFocus,this)),c('<span class="redactor_placeholder" data-redactor="verified">').attr("contenteditable",
!1).text(this.opts.placeholder)):!1},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var a="";!1===this.opts.linebreaks&&(a=this.opts.emptyHtml);this.$editor.off("focus.redactor_placeholder");this.$editor.html(a);!1===this.opts.linebreaks&&this.selectionStart(this.$editor.children()[0]);this.sync()},placeholderRemove:function(){this.opts.placeholder=!1;this.$editor.find("span.redactor_placeholder").remove();this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(a){return a.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,
"")},shortcuts:function(a,b){this.opts.shortcuts&&(a.altKey?48===b?this.shortcutsLoadFormat(a,"p"):49===b?this.shortcutsLoadFormat(a,"h1"):50===b?this.shortcutsLoadFormat(a,"h2"):51===b?this.shortcutsLoadFormat(a,"h3"):52===b?this.shortcutsLoadFormat(a,"h4"):53===b?this.shortcutsLoadFormat(a,"h5"):54===b&&this.shortcutsLoadFormat(a,"h6"):77===b?this.shortcutsLoad(a,"removeFormat"):66===b?this.shortcutsLoad(a,"bold"):73===b?this.shortcutsLoad(a,"italic"):74===b?this.shortcutsLoad(a,"insertunorderedlist"):
75===b?this.shortcutsLoad(a,"insertorderedlist"):72===b?this.shortcutsLoad(a,"superscript"):76===b&&this.shortcutsLoad(a,"subscript"))},shortcutsLoad:function(a,b){a.preventDefault();this.execCommand(b,!1)},shortcutsLoadFormat:function(a,b){a.preventDefault();this.formatBlocks(b)},focus:function(){this.browser("opera")?this.$editor.focus():this.window.setTimeout(c.proxy(this.focusSet,this,!0),1)},focusEnd:function(){this.focusSet()},focusSet:function(a){this.$editor.focus();var b=this.getRange();
b.selectNodeContents(this.$editor[0]);b.collapse(a||!1);a=this.getSelection();a.removeAllRanges();a.addRange(b)},toggle:function(a){if(this.opts.visual){!1!==a&&this.selectionSave();var b=null;this.opts.iframe?(b=this.$frame.height(),this.opts.fullpage&&this.$editor.removeAttr("contenteditable"),this.$frame.hide()):(b=this.$editor.innerHeight(),this.$editor.hide());this.modified=a=this.$source.val();this.$source.height(b).show().focus();this.$source.on("keydown.redactor-textarea",function(a){if(9===
a.keyCode){a=c(this);var b=a.get(0).selectionStart;a.val(a.val().substring(0,b)+"\t"+a.val().substring(a.get(0).selectionEnd));a.get(0).selectionStart=a.get(0).selectionEnd=b+1;return!1}});this.buttonInactiveVisual();this.buttonActive("html");this.opts.visual=!1}else a=this.$source.hide().val(),"undefined"!==typeof this.modified&&(this.modified=this.cleanRemoveSpaces(this.modified,!1)!==this.cleanRemoveSpaces(a,!1)),this.modified&&(this.opts.fullpage&&""===a?this.setFullpageOnInit(a):(this.set(a),
this.opts.fullpage&&this.buildBindKeyboard())),this.opts.iframe?this.$frame.show():this.$editor.show(),this.opts.fullpage&&this.$editor.attr("contenteditable",!0),this.$source.off("keydown.redactor-textarea"),this.$editor.focus(),this.selectionRestore(),this.observeStart(),this.buttonActiveVisual(),this.buttonInactive("html"),this.opts.visual=!0},autosave:function(){var a=!1;this.autosaveInterval=setInterval(c.proxy(function(){var b=this.get();a!==b&&c.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+
"="+escape(encodeURIComponent(b)),success:c.proxy(function(c){this.callback("autosave",!1,c);a=b},this)})},this),1E3*this.opts.autosaveInterval)},toolbarBuild:function(){if(this.opts.air)this.opts.buttons=this.opts.airButtons;else if(!this.opts.buttonSource){var a=this.opts.buttons.indexOf("html"),b=this.opts.buttons[a+1];this.opts.buttons.splice(a,1);"|"===b&&this.opts.buttons.splice(a,1)}c.extend(this.opts.toolbar,this.opts.buttonsCustom);c.each(this.opts.buttonsAdd,c.proxy(function(a,b){this.opts.buttons.push(b)},
this));this.opts.toolbar&&c.each(this.opts.toolbar.formatting.dropdown,c.proxy(function(a){"-1"==c.inArray(a,this.opts.formattingTags)&&delete this.opts.toolbar.formatting.dropdown[a]},this));if(0===this.opts.buttons.length)return!1;this.airEnable();this.$toolbar=c("<ul>").addClass("redactor_toolbar").attr("id","redactor_toolbar_"+this.uuid);this.opts.air?(this.$air=c('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide(),this.$air.append(this.$toolbar),c("body").append(this.$air)):
this.opts.toolbarExternal?c(this.opts.toolbarExternal).html(this.$toolbar):this.$box.prepend(this.$toolbar);c.each(this.opts.buttons,c.proxy(function(a,b){if("|"===b)this.$toolbar.append(c(this.opts.buttonSeparator));else if(this.opts.toolbar[b]){var g=this.opts.toolbar[b];if(!1===this.opts.fileUpload&&"file"===b)return!0;this.$toolbar.append(c("<li>").append(this.buttonBuild(b,g)))}},this));this.$toolbar.find("a").attr("tabindex","-1");this.opts.toolbarFixed&&(this.toolbarObserveScroll(),c(document).on("scroll.redactor",
c.proxy(this.toolbarObserveScroll,this)));this.opts.activeButtons&&(a=c.proxy(this.buttonActiveObserver,this),this.$editor.on("mouseup.redactor keyup.redactor",a))},toolbarObserveScroll:function(){var a=c(this.document).scrollTop(),b=this.$box.offset().top,d=0,e=b+this.$box.height()+40;a>b?(b="100%",this.opts.toolbarFixedBox&&(d=this.$box.offset().left,b=this.$box.innerWidth(),this.$toolbar.addClass("toolbar_fixed_box")),this.toolbarFixed=!0,this.$toolbar.css({position:"fixed",width:b,zIndex:1005,
top:this.opts.toolbarFixedTopOffset+"px",left:d}),a<e?this.$toolbar.css("visibility","visible"):this.$toolbar.css("visibility","hidden")):(this.toolbarFixed=!1,this.$toolbar.css({position:"relative",width:"auto",top:0,left:d}),this.opts.toolbarFixedBox&&this.$toolbar.removeClass("toolbar_fixed_box"))},airEnable:function(){if(this.opts.air)this.$editor.on("mouseup.redactor keyup.redactor",this,c.proxy(function(a){var b=this.getSelectionText();"mouseup"===a.type&&""!=b&&this.airShow(a);"keyup"===a.type&&
(a.shiftKey&&""!=b)&&(a=c(this.getElement(this.getSelection().focusNode)),b=a.offset(),b.height=a.height(),this.airShow(b,!0))},this))},airShow:function(a,b){if(this.opts.air){var d,e;c(".redactor_air").hide();b?(d=a.left,e=a.top+a.height+14,this.opts.iframe&&(e+=this.$box.position().top-c(this.document).scrollTop(),d+=this.$box.position().left)):(e=this.$air.innerWidth(),d=a.clientX,c(this.document).width()<d+e&&(d-=e),e=a.clientY+14,this.opts.iframe?(e+=this.$box.position().top,d+=this.$box.position().left):
e+=c(this.document).scrollTop());this.$air.css({left:d+"px",top:e+"px"}).show();this.airBindHide()}},airBindHide:function(){if(this.opts.air){var a=c.proxy(function(a){c(a).on("mousedown.redactor",c.proxy(function(d){0===c(d.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),this.selectionRemove(),c(a).off(d))},this)).on("keydown.redactor",c.proxy(function(d){d.which===this.keyCode.ESC&&this.getSelection().collapseToStart();this.$air.fadeOut(100);c(a).off(d)},this))},this);a(document);
this.opts.iframe&&a(this.document)}},airBindMousemoveHide:function(){if(this.opts.air){var a=c.proxy(function(a){c(a).on("mousemove.redactor",c.proxy(function(d){0===c(d.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),c(a).off(d))},this))},this);a(document);this.opts.iframe&&a(this.document)}},pickerBuild:function(a,b){a.width(210);var d="color";"backcolor"===b&&(d="background-color");for(var e=this.opts.colors.length,g=this,f=0;f<e;f++){var h=this.opts.colors[f],h=c('<a rel="'+h+'" href="javascript:;" class="redactor_color_link"></a>').css({backgroundColor:h});
a.append(h);h.on("click",function(){var a=c(this).attr("rel");"backcolor"===b&&(a=c(this).css("background-color"));g.pickerSet(d,a)})}e=c('<a href="javascript:;" class="redactor_color_none"></a>').html(this.opts.curLang.none).on("click",function(){g.pickerSet(d,!1)});a.append(e)},pickerSet:function(a,b){this.bufferSet();this.$editor.focus();this.inlineRemoveStyle(a);!1!==b&&this.inlineSetStyle(a,b);this.opts.air&&this.$air.fadeOut(100);this.sync()},dropdownBuild:function(a,b){c.each(b,c.proxy(function(b,
e){e.className||(e.className="");var g;"separator"===e.name?g=c('<a class="redactor_separator_drop">'):(g=c('<a href="javascript:;" class="'+e.className+" redactor_dropdown_"+b+'">'+e.title+"</a>"),g.on("click",c.proxy(function(a){a.preventDefault&&a.preventDefault();this.browser("msie")&&(a.returnValue=!1);e.callback&&e.callback.call(this,b,g,e,a);e.exec&&this.execCommand(e.exec,b);if(e.func)this[e.func](b);this.buttonActiveObserver();this.opts.air&&this.$air.fadeOut(100)},this)));a.append(g)},this))},
dropdownShow:function(a,b,d){if(!this.opts.visual)return a.preventDefault(),!1;if(this.buttonGet(d).hasClass("dropact"))this.dropdownHideAll();else{this.dropdownHideAll();this.buttonActive(d);this.buttonGet(d).addClass("dropact");d=this.buttonGet(d).position();var e=d.left+"px";this.opts.air?b.css({position:"absolute",left:e,top:"29px"}).show():this.opts.toolbarFixed&&this.toolbarFixed?b.css({position:"fixed",left:e,top:"29px"}).show():b.css({position:"absolute",left:e,top:d.top+29+"px"}).show()}d=
c.proxy(function(a){this.dropdownHide(a,b)},this);c(document).one("click",d);this.$editor.one("click",d);a.stopPropagation()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact");c(".redactor_dropdown").hide()},dropdownHide:function(a,b){c(a.target).hasClass("dropact")||(b.removeClass("dropact"),this.dropdownHideAll())},buttonBuild:function(a,b){var d=c('<a href="javascript:;" title="'+b.title+'" class="redactor_btn redactor_btn_'+a+'"></a>'),
e=c('<div class="redactor_dropdown" style="display: none;">');d.on("click",c.proxy(function(c){c.preventDefault&&c.preventDefault();this.browser("msie")&&(c.returnValue=!1);if(d.hasClass("redactor_button_disabled"))return!1;!1===this.isFocused()&&this.$editor.focus();b.exec?(this.execCommand(b.exec,a),this.airBindMousemoveHide()):b.func&&"show"!==b.func?(this[b.func](a),this.airBindMousemoveHide()):b.callback?(b.callback.call(this,a,d,b,c),this.airBindMousemoveHide()):("backcolor"===a||"fontcolor"===
a||b.dropdown)&&this.dropdownShow(c,e,a);this.buttonActiveObserver(!1,a)},this));if("backcolor"===a||"fontcolor"===a||b.dropdown)e.appendTo(this.$toolbar),"backcolor"===a||"fontcolor"===a?this.pickerBuild(e,a):this.dropdownBuild(e,b.dropdown);return d},buttonGet:function(a){return!this.opts.toolbar?!1:c(this.$toolbar.find("a.redactor_btn_"+a))},buttonActiveToggle:function(a){a=this.buttonGet(a);a.hasClass("redactor_act")?a.removeClass("redactor_act"):a.addClass("redactor_act")},buttonActive:function(a){this.buttonGet(a).addClass("redactor_act")},
buttonInactive:function(a){this.buttonGet(a).removeClass("redactor_act")},buttonInactiveAll:function(a){c.each(this.opts.activeButtons,c.proxy(function(b,c){c!=a&&this.buttonInactive(c)},this))},buttonActiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").addClass("redactor_button_disabled")},buttonChangeIcon:function(a,b){this.buttonGet(a).addClass("redactor_btn_"+
b)},buttonRemoveIcon:function(a,b){this.buttonGet(a).removeClass("redactor_btn_"+b)},buttonAddSeparator:function(){this.$toolbar.append(c(this.opts.buttonSeparator))},buttonAddSeparatorAfter:function(a){this.buttonGet(a).parent().after(c(this.opts.buttonSeparator))},buttonAddSeparatorBefore:function(a){this.buttonGet(a).parent().before(c(this.opts.buttonSeparator))},buttonRemoveSeparatorAfter:function(a){this.buttonGet(a).parent().next().remove()},buttonRemoveSeparatorBefore:function(a){this.buttonGet(a).parent().prev().remove()},
buttonSetRight:function(a){this.opts.toolbar&&this.buttonGet(a).parent().addClass("redactor_btn_right")},buttonSetLeft:function(a){this.opts.toolbar&&this.buttonGet(a).parent().removeClass("redactor_btn_right")},buttonAdd:function(a,b,d,e){this.opts.toolbar&&(a=this.buttonBuild(a,{title:b,callback:d,dropdown:e}),this.$toolbar.append(c("<li>").append(a)))},buttonAddFirst:function(a,b,d,e){this.opts.toolbar&&(a=this.buttonBuild(a,{title:b,callback:d,dropdown:e}),this.$toolbar.prepend(c("<li>").append(a)))},
buttonAddAfter:function(a,b,d,e,g){this.opts.toolbar&&(b=this.buttonBuild(b,{title:d,callback:e,dropdown:g}),this.buttonGet(a).parent().after(c("<li>").append(b)))},buttonAddBefore:function(a,b,d,e,g){this.opts.toolbar&&(b=this.buttonBuild(b,{title:d,callback:e,dropdown:g}),this.buttonGet(a).parent().before(c("<li>").append(b)))},buttonRemove:function(a,b){var c=this.buttonGet(a);b&&c.parent().next().remove();c.parent().removeClass("redactor_btn_right");c.remove()},buttonActiveObserver:function(a,
b){var d=this.getParent();this.buttonInactiveAll(b);if(!1===a)this.buttonActiveToggle(b);else{d&&"A"===d.tagName?this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit):this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert);this.opts.activeButtonsAdd&&(c.each(this.opts.activeButtonsAdd,c.proxy(function(a,b){this.opts.activeButtons.push(b)},this)),c.extend(this.opts.activeButtonsStates,this.opts.activeButtonsAdd));c.each(this.opts.activeButtonsStates,
c.proxy(function(a,b){0!=c(d).closest(a,this.$editor.get()[0]).length&&this.buttonActive(b)},this));var e=c(d).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(e.length)switch(e.css("text-align")){case "right":this.buttonActive("alignright");break;case "center":this.buttonActive("aligncenter");break;case "justify":this.buttonActive("justify");break;default:this.buttonActive("alignleft")}}},exec:function(a,b,c){"formatblock"===a&&this.browser("msie")&&(b="<"+b+">");"inserthtml"===
a&&this.browser("msie")?(this.$editor.focus(),this.document.selection.createRange().pasteHTML(b)):this.document.execCommand(a,!1,b);!1!==c&&this.sync();this.callback("execCommand",a,b)},execCommand:function(a,b,d){if(!this.opts.visual)return this.$source.focus(),!1;if("inserthtml"===a)this.insertHtml(b,d),this.callback("execCommand",a,b);else{if(this.currentOrParentIs("PRE")&&!this.opts.formattingPre)return!1;if("insertunorderedlist"===a||"insertorderedlist"===a){var e=this.getParent();d=c(e).closest("ol, ul");
e=!1;if(d.length){var e=!0,g=d[0].tagName;if("insertunorderedlist"===a&&"OL"===g||"insertorderedlist"===a&&"UL"===g)e=!1}this.bufferSet();this.selectionSave();if(e){e=this.getNodes();d=this.getBlocks(e);"undefined"!=typeof e[0]&&(1<e.length&&3==e[0].nodeType)&&d.unshift(this.getBlock());var f="",h="";c.each(d,c.proxy(function(a,b){if("LI"==b.tagName){var d=c(b),e=d.clone();e.find("ul","ol").remove();f=!1===this.opts.linebreaks?f+this.outerHtml(c("<p>").append(e.contents())):f+(e.html()+"<br>");0==
a?(d.addClass("redactor-replaced").empty(),h=this.outerHtml(d)):d.remove()}},this));html=this.$editor.html().replace(h,"</"+g+">"+f+"<"+g+">");this.$editor.html(html);this.$editor.find(g+":empty").remove()}else this.document.execCommand(a),e=this.getParent(),d=c(e).parents("ol, ul"),d.length&&((this.browser("msie")||this.browser("mozilla"))&&"LI"!==e.tagName&&c(e).replaceWith(c(e).html()),g=d.parent(),this.isParentRedactor(g)&&this.nodeTestBlocks(g[0])&&g.replaceWith(g.contents())),this.browser("mozilla")&&
this.$editor.focus();this.selectionRestore();this.sync();this.callback("execCommand",a,b)}else{if("unlink"===a&&(this.bufferSet(),e=this.getParent(),"A"===c(e)[0].tagName)){c(e).replaceWith(c(e).text());this.sync();this.callback("execCommand",a,b);return}this.exec(a,b,d);"inserthorizontalrule"===a&&this.$editor.find("hr").removeAttr("id")}}},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(a){if("indent"===
a){if((a=this.getBlock())&&"LI"==a.tagName){this.selectionSave();a=this.getParent();var b=c(a).closest("ol, ul")[0].tagName,d=this.getBlocks();c.each(d,function(a,d){if("LI"==d.tagName){var f=c(d).prev();if(0!=f.size()&&"LI"==f[0].tagName){var h=f.children("ul, ol");0==h.size()?f.append(c("<"+b+">").append(d)):h.append(d)}}});this.selectionRestore()}}else{this.selectionSave();if((a=this.getBlock())&&"LI"==a.tagName)d=this.getBlocks(),this.insideOutdent(a,0,d);this.selectionRestore()}},insideOutdent:function(a,
b,d){if(a&&"LI"==a.tagName){var e=c(a).parent().parent();0!=e.size()&&"LI"==e[0].tagName?e.after(a):"undefined"!=typeof d[b]?(a=d[b],b++,this.insideOutdent(a,b,d)):this.execCommand("insertunorderedlist")}},cleanEmpty:function(a){var b=this.placeholderStart(a);if(!1!==b)return b;!1===this.opts.linebreaks&&(""===a?a=this.opts.emptyHtml:-1!==a.search(/^<hr\s?\/?>$/gi)&&(a="<hr>"+this.opts.emptyHtml));return a},cleanConverters:function(a){this.opts.convertDivs&&(a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,
"<p$1>$2</p>"));this.opts.paragraphy&&(a=this.cleanParagraphy(a));return a},cleanConvertProtected:function(a){a=a.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>');a=a.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>');a=a.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>');return a=this.opts.phpTags?
a.replace(/<\?php([\w\W]*?)\?>/gi,'<section style="display: none;" rel="redactor-php-tag">$1</section>'):a.replace(/<\?php([\w\W]*?)\?>/gi,"")},cleanReConvertProtected:function(a){a=a.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2\x3c/script>');a=a.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>");a=a.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,
"<form$1$2>$3</form>");this.opts.phpTags&&(a=a.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>"));return a},cleanRemoveSpaces:function(a,b){if(!1!==b){b=[];var d=0,e;e=a.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);null!==e&&c.each(e,function(c,e){d=c;a=a.replace(e,"buffer_"+d);b.push(e)});this.opts.phpTags&&(e=a.match(/<\?php([\w\W]*?)\?>/gi),null!==e&&c.each(e,function(c,e){d+=c;a=a.replace(e,"buffer_"+
c);b.push(e)}))}a=a.replace(/\n/g," ");a=a.replace(/[\t]*/g,"");a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/g," ");a=a.replace(/[\s\n]*$/g," ");a=a.replace(/>\s{2,}</g,"><");!1!==b&&(a=this.cleanReplacer(b,a));return a=a.replace(/\n\n/g,"\n")},cleanReplacer:function(a,b){a&&c.each(a,function(a,c){b=b.replace("buffer_"+a,c)});return b},cleanRemoveEmptyTags:function(a){a=a.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");a=a.replace(/[\u200B-\u200D\uFEFF]/g,"");for(var b="<pre></pre> <blockquote>\\s*</blockquote> <dd></dd> <dt></dt> <em>\\s*</em> <ul></ul> <ol></ol> <li></li> <table></table> <tr></tr> <span>\\s*<span> <span>&nbsp;<span> <b>\\s*</b> <b>&nbsp;</b> <p>\\s*</p> <p></p> <p>&nbsp;</p> <p>\\s*<br>\\s*</p> <div>\\s*</div> <div>\\s*<br>\\s*</div>".split(" "),
c=b.length,e=0;e<c;++e)a=a.replace(RegExp(b[e],"gi"),"");return a},cleanParagraphy:function(a){function b(b,c,d){return a.replace(RegExp(b,c),d)}a=c.trim(a);if(!0===this.opts.linebreaks)return a;if(""===a||"<p></p>"===a)return this.opts.emptyHtml;a+="\n";var d=[],e=0;-1!==a.search(/<(table|div|pre|object)/gi)&&c.each(a.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi),function(b,c){e++;d[e]=c;a=a.replace(c,"{replace"+e+"}\n")});this.opts.phpTags&&-1!==a.search(/<section(.*?)rel="redactor-php-tag">/gi)&&
c.each(a.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi),function(b,c){e++;d[e]=c;a=a.replace(c,"{replace"+e+"}\n")});a=a.replace(/<\!\-\-([\w\W]*?)\-\->/gi,"<comment>$1</comment>");a=a.replace(/<br \/>\s*<br \/>/gi,"\n\n");a=b("(<(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)",
"gi","\n$1");a=b("(</(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)>)","gi","$1\n\n");a=b("\r\n","g","\n");a=b("\r","g","\n");a=b("/\n\n+/","g","\n\n");var g=a.split(RegExp("\ns*\n","g"),-1);a="";for(var f in g)g.hasOwnProperty(f)&&(a=
-1==g[f].search("{replace")?a+("<p>"+g[f].replace(/^\n+|\n+$/g,"")+"</p>"):a+g[f]);-1!==a.search(/<blockquote/gi)&&c.each(a.match(/<blockquote(.*?)>([\w\W]*?)<\/blockquote>/gi),function(b,c){var d="",d=c.replace("<p>",""),d=d.replace("</p>","<br>");a=a.replace(c,d)});a=b("<p>s*</p>","gi","");a=b("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>");a=b("<p>s*(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*</p>",
"gi","$1");a=b("<p>(<li.+?)</p>","gi","$1");a=b("<p>s*(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)","gi","$1");a=b("(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*</p>",
"gi","$1");a=b("(</?(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)[^>]*>)s*<br />","gi","$1");a=b("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1");a=b("\n</p>","gi","</p>");a=b("</li><p>","gi","</li>");a=b("</ul><p>(.*?)</li>",
"gi","</ul></li>");a=b("</ol><p>","gi","</ol>");a=b("<p>\t?\n?<p>","gi","<p>");a=b("</dt><p>","gi","</dt>");a=b("</dd><p>","gi","</dd>");a=b("<br></p></blockquote>","gi","</blockquote>");c.each(d,function(b,c){a=a.replace("{replace"+b+"}",c)});a=a.replace(/<comment>([\w\W]*?)<\/comment>/gi,"\x3c!--$1--\x3e");return c.trim(a)},cleanConvertInlineTags:function(a){var b="strong";"b"===this.opts.boldTag&&(b="b");var c="em";"i"===this.opts.italicTag&&(c="i");a=a.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,
"<"+c+">$1</"+c+">");a=a.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+b+">$1</"+b+">");a="strong"===this.opts.boldTag?a.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>"):a.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>");a="em"===this.opts.italicTag?a.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>"):a.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>");a=a.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>");/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi.test(a)||
(a=a.replace(/<span(.*?)(?!data-redactor="verified")(.*?)>([\w\W]*?)<\/span>/gi,'<span$1 data-redactor="verified"$2>$3</span>'));return a},cleanStripTags:function(a){if(""==a||"undefined"==typeof a)return a;var b=!1;!1!==this.opts.allowedTags&&(b=!0);var d=!0===b?this.opts.allowedTags:this.opts.deniedTags;a=a.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(a,g){return!0===b?"-1"<c.inArray(g.toLowerCase(),d)?a:"":"-1"<c.inArray(g.toLowerCase(),d)?"":a});return a=this.cleanConvertInlineTags(a)},cleanSavePreCode:function(a,
b){var d=a.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);null!==d&&c.each(d,c.proxy(function(c,d){var f=d.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);f[3]=f[3].replace(/&nbsp;/g," ");!1!==b&&(f[3]=this.cleanEncodeEntities(f[3]));a=a.replace(d,"<"+f[1]+f[2]+">"+f[3]+"</"+f[1]+">")},this));return a},cleanEncodeEntities:function(a){a=String(a).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,
"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var a=this.$editor.find("img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");a.filter('[style*="font-size"][style*="line-height"]').css("font-size","").css("line-height","");a.filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height","");a.filter('[style*="background-color: transparent;"]').css("background-color","");c.each(a,c.proxy(function(a,c){this.removeEmptyAttr(c,
"style")},this));this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(a){var b=0,c=a.length,e=0,g=null,e=null,f="",h="",f="";for(this.cleanlevel=0;b<c;b++){e=b;if(-1==a.substr(b).indexOf("<")){h+=a.substr(b);break}for(;e<c&&"<"!=a.charAt(e);)e++;b!=e&&(f=a.substr(b,e-b),f.match(/^\s{2,}$/g)||("\n"==h.charAt(h.length-1)?h+=this.cleanGetTabs():"\n"==f.charAt(0)&&(h+="\n"+this.cleanGetTabs(),f=f.replace(/^\s+/,"")),h+=f),f.match(/\n/)&&(h+="\n"+this.cleanGetTabs()));
for(g=e;e<c&&">"!=a.charAt(e);)e++;f=a.substr(g,e-g);b=e;if("!--"==f.substr(1,3)){if(!f.match(/--$/)){for(;"--\x3e"!=a.substr(e,3);)e++;e+=2;f=a.substr(g,e-g);b=e}"\n"!=h.charAt(h.length-1)&&(h+="\n");h+=this.cleanGetTabs();h+=f+">\n"}else if("!"==f[1])h=this.placeTag(f+">",h);else if("?"==f[1])h+=f+">\n";else if(e=f.match(/^<(script|style|pre)/i)){if(e[1]=e[1].toLowerCase(),f=this.cleanTag(f),h=this.placeTag(f,h),e=String(a.substr(b+1)).toLowerCase().indexOf("</"+e[1]))f=a.substr(b+1,e),b+=e,h+=
f}else f=this.cleanTag(f),h=this.placeTag(f,h)}return this.cleanFinish(h)},cleanGetTabs:function(){for(var a="",b=0;b<this.cleanlevel;b++)a+="\t";return a},cleanFinish:function(a){a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/,"");a=a.replace(/[\s\n]*$/,"");a=a.replace(/<script(.*?)>\n<\/script>/gi,"<script$1>\x3c/script>");this.cleanlevel=0;return a},cleanTag:function(a){var b="";a=a.replace(/\n/g," ");a=a.replace(/\s{2,}/g," ");a=a.replace(/^\s+|\s+$/g," ");var c="";a.match(/\/$/)&&(c="/",
a=a.replace(/\/+$/,""));for(var e;e=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(a);)e[2]?b+=e[1].toLowerCase()+"="+e[2]:e[1]&&(b+=e[1].toLowerCase()),b+=" ",a=a.substr(e[0].length);return b.replace(/\s*$/,"")+c+">"},placeTag:function(a,b){var c=a.match(this.cleannewLevel);if(a.match(this.cleanlineBefore)||c)b=b.replace(/\s*$/,""),b+="\n";c&&"/"==a.charAt(1)&&this.cleanlevel--;"\n"==b.charAt(b.length-1)&&(b+=this.cleanGetTabs());c&&"/"!=a.charAt(1)&&this.cleanlevel++;b+=a;if(a.match(this.cleanlineAfter)||
a.match(this.cleannewLevel))b=b.replace(/ *$/,""),b+="\n";return b},alignmentLeft:function(){this.alignmentSet("","JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(a,b){this.bufferSet();if(this.oldIE())return this.document.execCommand(b,!1,!1),!0;this.selectionSave();var d=this.getBlocks();c.each(d,
c.proxy(function(b,d){var f=!1;if(f=-1!==c.inArray(d.tagName,this.opts.alignmentTags)?c(d):c(d).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]))f.css("text-align",a),this.removeEmptyAttr(f,"style")},this));this.selectionRestore();this.sync()},formatEmpty:function(a){var b=c.trim(this.$editor.html()),b=b.replace(/<br\s?\/?>/i,""),d=b.replace(/<p>\s?<\/p>/gi,"");if(""===b||""===d)a.preventDefault(),a=c(this.opts.emptyHtml).get(0),this.$editor.html(a),this.focus();this.sync()},
formatBlocks:function(a){this.bufferSet();var b=this.getBlocks();this.selectionSave();c.each(b,c.proxy(function(b,c){"LI"!==c.tagName&&this.formatBlock(a,c)},this));this.selectionRestore();this.sync()},formatBlock:function(a,b){!1===b&&(b=this.getBlock());if(!1===b)return!0===this.opts.linebreaks&&this.execCommand("formatblock",a),!0;var d="";"pre"!==a?d=c(b).contents():(d=c(b).html(),""===c.trim(d)&&(d='<span id="selection-marker-1"></span>'));"PRE"===b.tagName&&(a="p");!0===this.opts.linebreaks&&
"p"===a?c(b).replaceWith(c("<div>").append(d).html()+"<br>"):(d=c("<"+a+">").append(d),c(b).replaceWith(d))},formatChangeTag:function(a,b,d){!1!==d&&this.selectionSave();var e=c("<"+b+"/>");c(a).replaceWith(function(){return e.append(c(this).contents())});!1!==d&&this.selectionRestore();return e},formatQuote:function(){this.bufferSet();if(!1===this.opts.linebreaks){this.selectionSave();var a=this.getBlocks();a&&c.each(a,c.proxy(function(a,b){"BLOCKQUOTE"===b.tagName?this.formatBlock("p",b,!1):"LI"!==
b.tagName&&this.formatBlock("blockquote",b,!1)},this));this.selectionRestore()}else if(a=this.getBlock(),"BLOCKQUOTE"===a.tagName)this.selectionSave(),c(a).replaceWith(c(a).html()+"<br>"),this.selectionRestore();else{var a=this.selectionWrap("blockquote"),b=c(a).html();c.each("ul ol table tr tbody thead tfoot dl".split(" "),function(a,c){b=b.replace(RegExp("<"+c+"(.*?)>","gi"),"");b=b.replace(RegExp("</"+c+">","gi"),"")});var d=this.opts.blockLevelElements;d.push("td");c.each(d,function(a,c){b=b.replace(RegExp("<"+
c+"(.*?)>","gi"),"");b=b.replace(RegExp("</"+c+">","gi"),"<br>")});c(a).html(b);this.selectionElement(a);a=c(a).next();"BR"===a[0].tagName&&a.remove()}this.sync()},blockRemoveAttr:function(a){var b=this.getBlocks();c(b).removeAttr(a);this.sync()},blockSetAttr:function(a,b){var d=this.getBlocks();c(d).attr(a,b);this.sync()},blockRemoveStyle:function(a){var b=this.getBlocks();c(b).css(a,"");this.removeEmptyAttr(b,"style");this.sync()},blockSetStyle:function(a,b){var d=this.getBlocks();c(d).css(a,b);
this.sync()},blockRemoveClass:function(a){var b=this.getBlocks();c(b).removeClass(a);this.removeEmptyAttr(b,"class");this.sync()},blockSetClass:function(a){var b=this.getBlocks();c(b).addClass(a);this.sync()},inlineRemoveClass:function(a){this.selectionSave();this.inlineEachNodes(function(b){c(b).removeClass(a);this.removeEmptyAttr(b,"class")});this.selectionRestore();this.sync()},inlineSetClass:function(a){var b=this.getCurrent();c(b).hasClass(a)||this.inlineMethods("addClass",a)},inlineRemoveStyle:function(a){this.selectionSave();
this.inlineEachNodes(function(b){c(b).css(a,"");this.removeEmptyAttr(b,"style")});this.selectionRestore();this.sync()},inlineSetStyle:function(a,b){this.inlineMethods("css",a,b)},inlineRemoveAttr:function(a){this.selectionSave();var b=this.getRange(),d=this.getElement(),e=this.getNodes();if(b.collapsed||b.startContainer===b.endContainer&&d)e=c(d);c(e).removeAttr(a);this.inlineUnwrapSpan();this.selectionRestore();this.sync()},inlineSetAttr:function(a,b){this.inlineMethods("attr",a,b)},inlineMethods:function(a,
b,d){this.selectionSave();var e=this.getRange(),g=this.getElement();if(e.collapsed||e.startContainer===e.endContainer&&g)c(g)[a](b,d);else this.document.execCommand("fontSize",!1,4),e=this.$editor.find("font"),c.each(e,c.proxy(function(c,e){this.inlineSetMethods(a,e,b,d)},this));this.selectionRestore();this.sync()},inlineSetMethods:function(a,b,d,e){var g=c(b).parent();g&&"SPAN"===g[0].tagName?c(b).replaceWith(c(b).html()):(g=c('<span data-redactor="verified" data-redactor-inlineMethods>').append(c(b).contents()),
c(b).replaceWith(g));c(g)[a](d,e);return g},inlineEachNodes:function(a){var b=this.getRange(),d=this.getElement(),e=this.getNodes(),g;if(b.collapsed||b.startContainer===b.endContainer&&d)e=c(d),g=!0;c.each(e,c.proxy(function(b,d){if(!g&&"SPAN"!==d.tagName)if("SPAN"===d.parentNode.tagName&&!c(d.parentNode).hasClass("redactor_editor"))d=d.parentNode;else return;a.call(this,d)},this))},inlineUnwrapSpan:function(){var a=this.$editor.find("span[data-redactor-inlineMethods]");c.each(a,c.proxy(function(a,
d){var e=c(d);void 0===e.attr("class")&&void 0===e.attr("style")&&e.contents().unwrap()},this))},inlineFormat:function(a){this.selectionSave();this.document.execCommand("fontSize",!1,4);var b=this.$editor.find("font");c.each(b,function(b,e){var g=c("<"+a+"/>").append(c(e).contents());c(e).replaceWith(g)});this.selectionRestore();this.sync()},inlineRemoveFormat:function(a){this.selectionSave();var b=a.toUpperCase();a=this.getNodes();c.each(a,function(a,e){e.tagName===b&&c(e).replaceWith(c(e).contents())});
this.selectionRestore();this.sync()},insertHtml:function(a,b){var d=this.getCurrent(),e=d.parentNode;this.$editor.focus();this.bufferSet();var g=c("<div>").append(a);a=g.html();a=this.cleanRemoveEmptyTags(a);var g=c("<div>").append(a),f=this.getBlock();if(1==g.contents().length){var h=g.contents()[0].tagName;if("P"!=h&&h==f.tagName||"PRE"==h)a=g.text(),g=c("<div>").append(a)}if(!this.opts.linebreaks&&1==g.contents().length&&3==g.contents()[0].nodeType&&(2<this.getRangeSelectedNodes().length||!d||
"BODY"==d.tagName&&!e||"HTML"==e.tagName))a="<p>"+a+"</p>";"BLOCKQUOTE"==f.tagName&&-1===a.indexOf("<a")?this.insertText(a):1<g.contents().length&&f||g.contents().is("p, :header, ul, ol, div, table, blockquote, pre, address, section, header, footer, aside, article")?this.browser("msie")?this.document.selection.createRange().pasteHTML(a):this.document.execCommand("inserthtml",!1,a):this.insertHtmlAdvanced(a);this.selectall&&this.window.setTimeout(c.proxy(function(){this.opts.linebreaks?this.focusEnd():
this.selectionEnd(this.$editor.contents().last())},this),1);this.observeStart();!1!==b&&this.sync()},insertHtmlAdvanced:function(a){var b=this.getSelection();if(b.getRangeAt&&b.rangeCount){var c=b.getRangeAt(0);c.deleteContents();var e=this.document.createElement("div");e.innerHTML=a;a=this.document.createDocumentFragment();for(var g,f;g=e.firstChild;)f=a.appendChild(g);c.insertNode(a);f&&(c=c.cloneRange(),c.setStartAfter(f),c.collapse(!0),b.removeAllRanges(),b.addRange(c))}},insertText:function(a){var b=
c(a);b.length&&(a=b.text());this.$editor.focus();this.browser("msie")?this.document.selection.createRange().pasteHTML(a):this.document.execCommand("inserthtml",!1,a);this.sync()},insertNode:function(a){a=a[0]||a;var b=this.getSelection();b.getRangeAt&&b.rangeCount&&(range=b.getRangeAt(0),range.deleteContents(),range.insertNode(a),range.setEndAfter(a),range.setStartAfter(a),b.removeAllRanges(),b.addRange(range))},insertAfterLastElement:function(a){if(this.isEndOfElement()){if(this.$editor.contents().last()[0]!==
a)return!1;this.bufferSet();if(!1===this.opts.linebreaks){var b=c(this.opts.emptyHtml);c(a).after(b);this.selectionStart(b)}else b=c('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0],c(a).after(b),c(b).after(this.opts.invisibleSpace),this.selectionRestore()}},insertLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},insertDoubleLineBreak:function(){this.selectionSave();
this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},replaceLineBreak:function(a){var b=c("<br>"+this.opts.invisibleSpace);c(a).replaceWith(b);this.selectionStart(b)},pasteClean:function(a){a=this.callback("pasteBefore",!1,a);if(this.currentOrParentIs("PRE"))return a=this.pastePre(a),this.pasteInsert(a),!0;a=a.replace(/\x3c!--[\s\S]*?--\x3e|<\?(?:php)?[\s\S]*?\?>/gi,"");a=a.replace(/(&nbsp;){2,}/gi,"&nbsp;");a=a.replace(/&nbsp;/gi,
" ");a=a.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");a=this.cleanStripTags(a);a=a.replace(/<td><\/td>/gi,"[td]");a=a.replace(/<td>&nbsp;<\/td>/gi,"[td]");a=a.replace(/<td><br><\/td>/gi,"[td]");a=a.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');a=a.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]");a=a.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]");a=a.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]");
a=a.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]");a=a.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]");a=a.replace(/<param(.*?)>/gi,"[param$1]");a=a.replace(/<img(.*?)style="(.*?)"(.*?)>/gi,"[img$1$3]");a=a.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>");a=a.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");a=a.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1");a=a.replace(/\[td\]/gi,"<td>&nbsp;</td>");a=a.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,
'<a href="$1">$2</a>');a=a.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>");a=a.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>");a=a.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>");a=a.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>");a=a.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>");a=a.replace(/\[param(.*?)\]/gi,"<param$1>");a=a.replace(/\[img(.*?)\]/gi,"<img$1>");this.opts.convertDivs&&
(a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>"),a=a.replace(/<\/div><p>/gi,"<p>"),a=a.replace(/<\/p><\/div>/gi,"</p>"));a=this.cleanParagraphy(a);a=a.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");a=a.replace(/<img>/gi,"");a=a.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");a=a.replace(/\n{3,}/gi,"\n");a=a.replace(/<p><p>/gi,"<p>");a=a.replace(/<\/p><\/p>/gi,"</p>");a=a.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>");a=a.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,
"</li>");!0===this.opts.linebreaks&&(a=a.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>"));a=a.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");if(this.browser("mozilla"))for(;/<br>$/gi.test(a);)a=a.replace(/<br>$/gi,"");for(;/<font>([\w\W]*?)<\/font>/gi.test(a);)a=a.replace(/<font>([\w\W]*?)<\/font>/gi,"$1");this.pasteInsert(a)},pastePre:function(a){a=a.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var b=this.document.createElement("div");b.innerHTML=a;return this.cleanEncodeEntities(b.textContent||
b.innerText)},pasteInsert:function(a){this.selectall&&(this.opts.linebreaks?this.$editor.html(""):this.$editor.html(this.opts.emptyHtml),this.$editor.focus());a=this.callback("pasteAfter",!1,a);this.insertHtml(a);this.selectall=!1;setTimeout(function(){m=!1},100);this.opts.autoresize?c(this.document.body).scrollTop(this.saveScroll):this.$editor.scrollTop(this.saveScroll)},bufferSet:function(a){void 0!==a?this.opts.buffer.push(a):(this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRemoveMarkers(!0))},
bufferUndo:function(){0===this.opts.buffer.length?this.$editor.focus():(this.selectionSave(),this.opts.rebuffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.buffer.pop()),this.selectionRestore(),setTimeout(c.proxy(this.observeStart,this),100))},bufferRedo:function(){if(0===this.opts.rebuffer.length)return this.$editor.focus(),!1;this.selectionSave();this.opts.buffer.push(this.$editor.html());this.selectionRestore(!1,!0);this.$editor.html(this.opts.rebuffer.pop());
this.selectionRestore(!0);setTimeout(c.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages();this.observeTables()},observeTables:function(){this.$editor.find("table").on("click",c.proxy(this.tableObserver,this))},observeImages:function(){if(!1===this.opts.observeImages)return!1;this.$editor.find("img").each(c.proxy(function(a,b){this.browser("msie")&&c(b).attr("unselectable","on");this.imageResize(b)},this))},getSelection:function(){return this.opts.rangy?this.opts.iframe?
rangy.getSelection(this.$frame[0]):rangy.getSelection():this.document.getSelection()},getRange:function(){if(this.opts.rangy)return this.opts.iframe?rangy.createRange(this.iframeDoc()):rangy.createRange();if(this.document.getSelection){var a=this.document.getSelection();if(a.getRangeAt&&a.rangeCount)return a.getRangeAt(0)}return this.document.createRange()},selectionElement:function(a){this.setCaret(a)},selectionStart:function(a){this.selectionSet(a[0]||a,0,null,0)},selectionEnd:function(a){this.selectionSet(a[0]||
a,1,null,1)},selectionSet:function(a,b,c,e){null==c&&(c=a);null==e&&(e=b);var g=this.getSelection();if(g){var f=this.getRange();f.setStart(a,b);f.setEnd(c,e);try{g.removeAllRanges()}catch(h){}g.addRange(f)}},selectionWrap:function(a){a=a.toLowerCase();var b=this.getBlock();if(b)return a=this.formatChangeTag(b,a),this.sync(),a;b=this.getSelection().getRangeAt(0);a=document.createElement(a);a.appendChild(b.extractContents());b.insertNode(a);this.selectionElement(a);return a},selectionAll:function(){var a=
this.getRange();a.selectNodeContents(this.$editor[0]);var b=this.getSelection();b.removeAllRanges();b.addRange(a)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(a){var b=0,b=this.getSelection().getRangeAt(0),d=b.cloneRange();d.selectNodeContents(a);d.setEnd(b.endContainer,b.endOffset);return b=c.trim(d.toString()).length},getCaretOffsetRange:function(){return new n(this.getSelection().getRangeAt(0))},setCaret:function(a,b,c){"undefined"===typeof c&&(c=b);
a=a[0]||a;var e=this.getRange();e.selectNodeContents(a);a=this.getTextNodesIn(a);var g=!1,f=0,h;if(1==a.length&&b)e.setStart(a[0],b),e.setEnd(a[0],c);else for(var j=0,k;k=a[j++];){h=f+k.length;if(!g&&b>=f&&(b<h||b==h&&j<a.length))e.setStart(k,b-f),g=!0;if(g&&c<=h){e.setEnd(k,c-f);break}f=h}b=this.getSelection();b.removeAllRanges();b.addRange(e)},getTextNodesIn:function(a){var b=[];if(3==a.nodeType)b.push(a);else{a=a.childNodes;for(var c=0,e=a.length;c<e;++c)b.push.apply(b,this.getTextNodesIn(a[c]))}return b},
selectionSave:function(){this.isFocused()||this.$editor.focus();this.opts.rangy?this.savedSel=rangy.saveSelection():this.selectionCreateMarker(this.getRange())},selectionCreateMarker:function(a){if(a){var b=c('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0],d=c('<span id="selection-marker-2">'+this.opts.invisibleSpace+"</span>",this.document)[0];!0===a.collapsed?this.selectionSetMarker(a,b,!0):(this.selectionSetMarker(a,b,!0),this.selectionSetMarker(a,d,!1));this.savedSel=
this.$editor.html();this.selectionRestore(!1,!1)}},selectionSetMarker:function(a,b,c){a=a.cloneRange();a.collapse(c);a.insertNode(b);a.detach()},selectionRestore:function(a,b){if(this.opts.rangy)rangy.restoreSelection(this.savedSel);else{!0===a&&this.savedSel&&this.$editor.html(this.savedSel);var c=this.$editor.find("span#selection-marker-1"),e=this.$editor.find("span#selection-marker-2");this.isFocused()||this.$editor.focus();0!=c.length&&0!=e.length?this.selectionSet(c[0],0,e[0],0):0!=c.length&&
this.selectionSet(c[0],0,null,0);!1!==b&&(this.selectionRemoveMarkers(),this.savedSel=!1)}},selectionRemoveMarkers:function(){this.opts.rangy?rangy.removeMarkers(this.savedSel):(this.$editor.find("span#selection-marker-1").remove(),this.$editor.find("span#selection-marker-2").remove())},getCurrent:function(){var a=!1,b=this.getSelection();0<b.rangeCount&&(a=b.getRangeAt(0).startContainer);return this.isParentRedactor(a)},getParent:function(a){return(a=a||this.getCurrent())?this.isParentRedactor(c(a).parent()[0]):
!1},getBlock:function(a){for("undefined"===typeof a&&(a=this.getCurrent());a;){if(this.nodeTestBlocks(a)){if(c(a).hasClass("redactor_editor"))break;return a}a=a.parentNode}return!1},getBlocks:function(a){var b=[];if("undefined"==typeof a){if((a=this.getRange())&&!0===a.collapsed)return[this.getBlock()];a=this.getNodes(a)}c.each(a,c.proxy(function(a,e){if(!1===this.opts.iframe&&0==c(e).parents("div.redactor_editor").size())return!1;this.nodeTestBlocks(e)&&b.push(e)},this));0===b.length&&(b=[this.getBlock()]);
return b},nodeTestBlocks:function(a){return 1==a.nodeType&&this.rTestBlock.test(a.nodeName)},tagTestBlock:function(a){return this.rTestBlock.test(a)},getSelectedNodes:function(a){if("undefined"==typeof a||!1==a)a=this.getRange();if(a&&!0===a.collapsed)return[this.getCurrent()];a=this.getSelection();try{var b=a.getRangeAt(0).cloneContents()}catch(c){return!1}a=this.document.createElement("span");a.appendChild(b);window.selnodes=a.childNodes;b=[];a=0;for(var e=selnodes.length;a<e;a++)b.push(selnodes[a]);
0==b.length&&b.push(this.getCurrent());return b},getNodes:function(a,b){if(this.opts.linebreaks)return this.getSelectedNodes(a);if("undefined"==typeof a||!1==a)a=this.getRange();if(a&&!0===a.collapsed){if("undefined"===typeof b&&this.tagTestBlock(b)){var d=this.getBlock();return d.tagName==b?[d]:[]}return[this.getCurrent()]}var d=[],e=[],g=this.document.getSelection();g.isCollapsed||(d=this.getRangeSelectedNodes(g.getRangeAt(0)));c.each(d,c.proxy(function(a,d){if(!1===this.opts.iframe&&0==c(d).parents("div.redactor_editor").size())return!1;
"undefined"===typeof b?""!=c.trim(d.textContent)&&e.push(d):d.tagName==b&&e.push(d)},this));if(0==e.length){if("undefined"===typeof b&&this.tagTestBlock(b))return d=this.getBlock(),d.tagName==b?e.push(d):[];e.push(this.getCurrent())}return e},getElement:function(a){for(a||(a=this.getCurrent());a;){if(1==a.nodeType){if(c(a).hasClass("redactor_editor"))break;return a}a=a.parentNode}return!1},getRangeSelectedNodes:function(a){a=a||this.getRange();var b=a.startContainer,c=a.endContainer;if(b==c)return[b];
for(var e=[];b&&b!=c;)e.push(b=this.nextNode(b));for(b=a.startContainer;b&&b!=a.commonAncestorContainer;)e.unshift(b),b=b.parentNode;return e},nextNode:function(a){if(a.hasChildNodes())return a.firstChild;for(;a&&!a.nextSibling;)a=a.parentNode;return!a?null:a.nextSibling},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var a="",b=this.getSelection();if(b.rangeCount){for(var a=this.document.createElement("div"),c=b.rangeCount,e=0;e<c;++e)a.appendChild(b.getRangeAt(e).cloneContents());
a=a.innerHTML}return this.syncClean(a)},tableShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,c.proxy(function(){c("#redactor_insert_table_btn").click(c.proxy(this.tableInsert,this));setTimeout(function(){c("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){var a=c("#redactor_table_rows").val(),b=c("#redactor_table_columns").val(),d=c("<div></div>"),e=Math.floor(99999*Math.random()),g=c('<table id="table'+e+'"><tbody></tbody></table>'),
f,h,j,k;for(f=0;f<a;f++){h=c("<tr></tr>");for(j=0;j<b;j++)k=c("<td>"+this.opts.invisibleSpace+"</td>"),0===f&&0===j&&k.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),c(h).append(k);g.append(h)}d.append(g);a=d.html();this.modalClose();this.selectionRestore();(b=this.getBlock()||this.getCurrent())?c(b).after(a):this.insertHtmlAdvanced(a);this.selectionRestore();e=this.$editor.find("#table"+e);this.tableObserver(e);this.buttonActiveObserver();e.removeAttr("id");this.sync()},
tableObserver:function(a){this.$table=c(a.target||a).closest("table");this.$tbody=c(a.target).closest("tbody");this.$thead=this.$table.find("thead");this.$current_td=c(a.target||this.$table.find("td").first());this.$current_tr=c(a.target||this.$table.find("tr").first()).closest("tr")},tableDeleteTable:function(){this.bufferSet();this.$table&&(this.$table.remove(),this.$table=!1,this.sync())},tableDeleteRow:function(){this.bufferSet();if(this.$current_tr){var a=this.$current_tr.prev().length?this.$current_tr.prev():
this.$current_tr.next();a.length&&(a=a.children("td").first(),a.length&&(a.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),this.selectionRestore()));this.$current_tr.remove();this.sync()}},tableDeleteColumn:function(){this.bufferSet();var a=this.$current_td.get(0).cellIndex;this.$table.find("tr").each(c.proxy(function(b,d){var e=0>a-1?a+1:a-1;0===b&&(c(d).find("td").eq(e).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),this.selectionRestore());
c(d).find("td").eq(a).remove()},this));this.sync()},tableAddHead:function(){this.bufferSet();if(0!==this.$table.find("thead").size())this.tableDeleteHead();else{var a=this.$table.find("tr").first().clone();a.find("td").html(this.opts.invisibleSpace);this.$thead=c("<thead></thead>");this.$thead.append(a);this.$table.prepend(this.$thead);this.sync()}},tableDeleteHead:function(){this.bufferSet();c(this.$thead).remove();this.$thead=!1;this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},
tableAddRowBelow:function(){this.tableAddRow("after")},tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(a){this.bufferSet();var b=this.$current_tr.clone();b.find("td").html(this.opts.invisibleSpace);"after"===a?this.$current_tr.after(b):this.$current_tr.before(b);this.sync()},tableAddColumn:function(a){this.bufferSet();var b=0;this.$current_tr.find("td").each(c.proxy(function(a,e){c(e)[0]===this.$current_td[0]&&
(b=a)},this));this.$table.find("tr").each(c.proxy(function(d,e){var g=c(e).find("td").eq(b),f=g.clone();f.html(this.opts.invisibleSpace);"after"===a?g.after(f):g.before(f)},this));this.sync()},videoShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,c.proxy(function(){c("#redactor_insert_video_btn").click(c.proxy(this.videoInsert,this));setTimeout(function(){c("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var a=c("#redactor_insert_video_area").val(),
a=this.cleanStripTags(a);this.selectionRestore();var b=this.getBlock()||this.getCurrent();b?(c(b).after(a),this.sync()):this.insertHtmlAdvanced(a);this.modalClose()},linkShow:function(){this.selectionSave();var a=c.proxy(function(){this.insert_link_node=!1;var a=this.getSelection(),d="",e="",g="",f=this.getParent();(e=c(f).parent().get(0))&&"A"===e.tagName&&(f=e);f&&"A"===f.tagName?(d=f.href,e=c(f).text(),g=f.target,this.insert_link_node=f):e=a.toString();c(".redactor_link_text").val(e);a=self.location.href.replace(/\/$/i,
"");a=d.replace(a,"");f=c("#redactor_tabs").find("a");!1===this.opts.linkEmail&&f.eq(1).remove();!1===this.opts.linkAnchor&&f.eq(2).remove();!1===this.opts.linkEmail&&!1===this.opts.linkAnchor?(c("#redactor_tabs").remove(),c("#redactor_link_url").val(a)):0===d.search("mailto:")?(this.modalSetTab.call(this,2),c("#redactor_tab_selected").val(2),c("#redactor_link_mailto").val(d.replace("mailto:",""))):0===a.search(/^#/gi)?(this.modalSetTab.call(this,3),c("#redactor_tab_selected").val(3),c("#redactor_link_anchor").val(a.replace(/^#/gi,
""))):c("#redactor_link_url").val(a);"_blank"===g&&c("#redactor_link_blank").prop("checked",!0);c("#redactor_insert_link_btn").click(c.proxy(this.linkProcess,this));setTimeout(function(){c("#redactor_link_url").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,a)},linkProcess:function(){var a=c("#redactor_tab_selected").val(),b="",d="",e="",g="";"1"===a?(b=c("#redactor_link_url").val(),d=c("#redactor_link_url_text").val(),c("#redactor_link_blank").prop("checked")&&
(e=' target="_blank"',g="_blank"),a=/^((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}/i,-1==b.search(/^(http|ftp|https):\/\/((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}/i)&&(0==b.search(a)&&this.opts.linkProtocol)&&(b=this.opts.linkProtocol+b)):"2"===a?(b="mailto:"+c("#redactor_link_mailto").val(),d=c("#redactor_link_mailto_text").val()):"3"===a&&(b="#"+c("#redactor_link_anchor").val(),d=c("#redactor_link_anchor_text").val());this.linkInsert('<a href="'+b+'"'+e+">"+d+"</a>",c.trim(d),b,g)},linkInsert:function(a,
b,d,e){this.selectionRestore();""!==b&&(this.insert_link_node?(this.bufferSet(),c(this.insert_link_node).text(b).attr("href",d),""!==e?c(this.insert_link_node).attr("target",e):c(this.insert_link_node).removeAttr("target"),this.sync()):this.exec("inserthtml",a));this.modalClose()},fileShow:function(){this.selectionSave();var a=c.proxy(function(){var a=this.getSelection(),d="",d=this.oldIE()?a.text:a.toString();c("#redactor_filename").val(d);this.isMobile()||this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,
uploadFields:this.opts.uploadFields,success:c.proxy(this.fileCallback,this),error:c.proxy(function(a,b){this.callback("fileUploadError",b)},this)});this.uploadInit("redactor_file",{auto:!0,url:this.opts.fileUpload,success:c.proxy(this.fileCallback,this),error:c.proxy(function(a,b){this.callback("fileUploadError",b)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,a)},fileCallback:function(a){this.selectionRestore();if(!1!==a){var b=c("#redactor_filename").val();""===
b&&(b=a.filename);b='<a href="'+a.filelink+'" id="filelink-marker">'+b+"</a>";this.browser("webkit")&&this.window.chrome&&(b+="&nbsp;");this.execCommand("inserthtml",b,!1);b=c(this.$editor.find("a#filelink-marker"));0!=b.size()?b.removeAttr("id"):b=!1;this.sync();this.callback("fileUpload",b,a)}this.modalClose()},imageShow:function(){this.selectionSave();var a=c.proxy(function(){this.opts.imageGetJson?c.getJSON(this.opts.imageGetJson,c.proxy(function(a){var b={},g=0;c.each(a,c.proxy(function(a,c){"undefined"!==
typeof c.folder&&(g++,b[c.folder]=g)},this));var f=!1;c.each(a,c.proxy(function(a,d){var g="";"undefined"!==typeof d.title&&(g=d.title);var h=0;!c.isEmptyObject(b)&&"undefined"!==typeof d.folder&&(h=b[d.folder],!1===f&&(f=".redactorfolder"+h));g=c('<img src="'+d.thumb+'" class="redactorfolder redactorfolder'+h+'" rel="'+d.image+'" title="'+g+'" />');c("#redactor_image_box").append(g);c(g).click(c.proxy(this.imageThumbClick,this))},this));if(!c.isEmptyObject(b)){c(".redactorfolder").hide();c(f).show();
var h=c('<select id="redactor_image_box_select">');c.each(b,function(a,b){h.append(c('<option value="'+b+'">'+a+"</option>"))});c("#redactor_image_box").before(h);h.change(function(a){c(".redactorfolder").hide();c(".redactorfolder"+c(a.target).val()).show()})}},this)):c("#redactor_tabs").find("a").eq(1).remove();if(this.opts.imageUpload||this.opts.s3)if(!this.isMobile()&&!1===this.opts.s3&&c("#redactor_file").length&&this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,
success:c.proxy(this.imageCallback,this),error:c.proxy(function(a,b){this.callback("imageUploadError",b)},this)}),!1===this.opts.s3)this.uploadInit("redactor_file",{auto:!0,url:this.opts.imageUpload,success:c.proxy(this.imageCallback,this),error:c.proxy(function(a,b){this.callback("imageUploadError",b)},this)});else c("#redactor_file").on("change.redactor",c.proxy(this.s3handleFileSelect,this));else if(c(".redactor_tab").hide(),this.opts.imageGetJson){var a=c("#redactor_tabs").find("a");a.eq(0).remove();
a.eq(1).addClass("redactor_tabs_act");c("#redactor_tab2").show()}else c("#redactor_tabs").remove(),c("#redactor_tab3").show();c("#redactor_upload_btn").click(c.proxy(this.imageCallbackLink,this));!this.opts.imageUpload&&!this.opts.imageGetJson&&setTimeout(function(){c("#redactor_file_link").focus()},200)},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,a)},imageEdit:function(a){var b=c(a.target),d=b.parent();a=c.proxy(function(){c("#redactor_file_alt").val(b.attr("alt"));c("#redactor_image_edit_src").attr("href",
b.attr("src"));c("#redactor_form_image_align").val(b.css("float"));"A"===c(d).get(0).tagName&&c("#redactor_file_link").val(c(d).attr("href"));c("#redactor_image_delete_btn").click(c.proxy(function(){this.imageRemove(b)},this));c("#redactorSaveBtn").click(c.proxy(function(){this.imageSave(b)},this))},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image_edit,380,a)},imageRemove:function(a){var b=c(a).parent();c(a).remove();b.length&&"P"===b[0].tagName&&(this.$editor.focus(),this.selectionStart(b));
this.callback("imageDelete",a);this.modalClose();this.sync()},imageSave:function(a){var b=c(a).parent();c(a).attr("alt",c("#redactor_file_alt").val());var d=c("#redactor_form_image_align").val();"left"===d?c(a).css({"float":"left",margin:"0 10px 10px 0"}):"right"===d?c(a).css({"float":"right",margin:"0 0 10px 10px"}):c(a).css({"float":"none",margin:"0"});d=c.trim(c("#redactor_file_link").val());""!==d?"A"!==c(b).get(0).tagName?c(a).replaceWith('<a href="'+d+'">'+this.outerHtml(a)+"</a>"):c(b).attr("href",
d):"A"===c(b).get(0).tagName&&c(b).replaceWith(this.outerHtml(a));this.modalClose();this.observeImages();this.sync()},imageResize:function(a){var b=c(a),d=!1,e=!1,g,f=b.width()/b.height();b.off("hover mousedown mouseup click mousemove");b.hover(function(){b.css("cursor","nw-resize")},function(){b.css("cursor","");d=!1});b.mousedown(function(a){a.preventDefault();f=b.width()/b.height();e=d=!0;Math.round(a.pageX-b.eq(0).offset().left);g=Math.round(a.pageY-b.eq(0).offset().top)});b.mouseup(c.proxy(function(){d=
!1;b.css("cursor","");this.sync()},this));b.click(c.proxy(function(a){e&&this.imageEdit(a)},this));b.mousemove(function(a){if(d){e=!1;Math.round(a.pageX-c(this).eq(0).offset().left);var j=Math.round(a.pageY-c(this).eq(0).offset().top)-g,k=b.height(),j=parseInt(k,10)+j,j=Math.round(j*f);10<j&&b.width(j);Math.round(a.pageX-c(this).eq(0).offset().left);g=Math.round(a.pageY-c(this).eq(0).offset().top)}})},imageThumbClick:function(a){a='<img id="image-marker" src="'+c(a.target).attr("rel")+'" alt="'+c(a.target).attr("title")+
'" />';this.opts.paragraphy&&(a="<p>"+a+"</p>");this.imageInsert(a,!0)},imageCallbackLink:function(){var a=c("#redactor_file_link").val();""!==a?(a='<img id="image-marker" src="'+a+'" />',!1===this.opts.linebreaks&&(a="<p>"+a+"</p>"),this.imageInsert(a,!0)):this.modalClose()},imageCallback:function(a){this.imageInsert(a)},imageInsert:function(a,b){this.selectionRestore();if(!1!==a){var d="";!0!==b?(d='<img id="image-marker" src="'+a.filelink+'" />',this.opts.paragraphy&&(d="<p>"+d+"</p>")):d=a;this.execCommand("inserthtml",
d,!1);d=c(this.$editor.find("img#image-marker"));d.length?d.removeAttr("id"):d=!1;this.sync();!0!==b&&this.callback("imageUpload",d,a)}this.modalClose();this.observeImages()},modalTemplatesInit:function(){c.extend(this.opts,{modal_file:String()+'<section><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data"><label>'+
this.opts.curLang.filename+'</label><input type="text" id="redactor_filename" class="redactor_input" /><div style="margin-top: 7px;"><input type="file" id="redactor_file" name="file" /></div></form></section>',modal_image_edit:String()+"<section><label>"+this.opts.curLang.title+'</label><input id="redactor_file_alt" class="redactor_input" /><label>'+this.opts.curLang.link+'</label><input id="redactor_file_link" class="redactor_input" /><label>'+this.opts.curLang.image_position+'</label><select id="redactor_form_image_align"><option value="none">'+
this.opts.curLang.none+'</option><option value="left">'+this.opts.curLang.left+'</option><option value="right">'+this.opts.curLang.right+'</option></select></section><footer><a href="#" id="redactor_image_delete_btn" class="redactor_modal_btn">'+this.opts.curLang._delete+'</a>&nbsp;&nbsp;&nbsp;<a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</a><input type="button" name="save" class="redactor_modal_btn" id="redactorSaveBtn" value="'+this.opts.curLang.save+
'" /></footer>',modal_image:String()+'<section><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">'+this.opts.curLang.upload+'</a><a href="#">'+this.opts.curLang.choose+'</a><a href="#">'+this.opts.curLang.link+'</a></div><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data"><div id="redactor_tab1" class="redactor_tab"><input type="file" id="redactor_file" name="file" /></div><div id="redactor_tab2" class="redactor_tab" style="display: none;"><div id="redactor_image_box"></div></div></form><div id="redactor_tab3" class="redactor_tab" style="display: none;"><label>'+
this.opts.curLang.image_web_link+'</label><input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  /></div></section><footer><a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</a><input type="button" name="upload" class="redactor_modal_btn" id="redactor_upload_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_link:String()+'<section><form id="redactorInsertLinkForm" method="post" action=""><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">URL</a><a href="#">Email</a><a href="#">'+
this.opts.curLang.anchor+'</a></div><input type="hidden" id="redactor_tab_selected" value="1" /><div class="redactor_tab" id="redactor_tab1"><label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+'</label></div><div class="redactor_tab" id="redactor_tab2" style="display: none;"><label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" /><label>'+
this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" /></div><div class="redactor_tab" id="redactor_tab3" style="display: none;"><label>'+this.opts.curLang.anchor+'</label><input type="text" class="redactor_input" id="redactor_link_anchor"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" /></div></form></section><footer><a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+
this.opts.curLang.cancel+'</a><input type="button" class="redactor_modal_btn" id="redactor_insert_link_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_table:String()+"<section><label>"+this.opts.curLang.rows+'</label><input type="text" size="5" value="2" id="redactor_table_rows" /><label>'+this.opts.curLang.columns+'</label><input type="text" size="5" value="3" id="redactor_table_columns" /></section><footer><a href="#" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+
'</a><input type="button" name="upload" class="redactor_modal_btn" id="redactor_insert_table_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_video:String()+'<section><form id="redactorInsertVideoForm"><label>'+this.opts.curLang.video_html_code+'</label><textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea></form></section><footer><a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</a><input type="button" class="redactor_modal_btn" id="redactor_insert_video_btn" value="'+
this.opts.curLang.insert+'" /></footer>'})},modalInit:function(a,b,d,e){var g=c("#redactor_modal_overlay");g.length||(this.$overlay=g=c('<div id="redactor_modal_overlay" style="display: none;"></div>'),c("body").prepend(this.$overlay));if(this.opts.modalOverlay)g.show().on("click",c.proxy(this.modalClose,this));var f=c("#redactor_modal");f.length||(this.$modal=f=c('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>'),
c("body").append(this.$modal));c("#redactor_modal_close").on("click",c.proxy(this.modalClose,this));this.hdlModalClose=c.proxy(function(a){if(a.keyCode===this.keyCode.ESC)return this.modalClose(),!1},this);c(document).keyup(this.hdlModalClose);this.$editor.keyup(this.hdlModalClose);this.modalcontent=!1;0==b.indexOf("#")?(this.modalcontent=c(b),c("#redactor_modal_inner").empty().append(this.modalcontent.html()),this.modalcontent.html("")):c("#redactor_modal_inner").empty().append(b);f.find("#redactor_modal_header").html(a);
"undefined"!==typeof c.fn.draggable&&(f.draggable({handle:"#redactor_modal_header"}),f.find("#redactor_modal_header").css("cursor","move"));var h=c("#redactor_tabs");if(h.length){var j=this;h.find("a").each(function(a,b){a++;c(b).on("click",function(b){b.preventDefault();h.find("a").removeClass("redactor_tabs_act");c(this).addClass("redactor_tabs_act");c(".redactor_tab").hide();c("#redactor_tab"+a).show();c("#redactor_tab_selected").val(a);!1===j.isMobile()&&(b=f.outerHeight(),f.css("margin-top",
"-"+(b+10)/2+"px"))})})}f.find(".redactor_btn_modal_close").on("click",c.proxy(this.modalClose,this));!1===this.isMobile()?(f.css({position:"fixed",top:"-2000px",left:"50%",width:d+"px",marginLeft:"-"+(d+60)/2+"px"}).show(),this.modalSaveBodyOveflow=c(document.body).css("overflow"),c(document.body).css("overflow","hidden")):f.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show();"function"===typeof e&&e();!1===this.isMobile()&&setTimeout(function(){var a=
f.outerHeight();f.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(a+10)/2+"px"})},20)},modalClose:function(){c("#redactor_modal_close").off("click",this.modalClose);c("#redactor_modal").fadeOut("fast",c.proxy(function(){var a=c("#redactor_modal_inner");!1!==this.modalcontent&&(this.modalcontent.html(a.html()),this.modalcontent=!1);a.html("");this.opts.modalOverlay&&c("#redactor_modal_overlay").hide().off("click",this.modalClose);c(document).unbind("keyup",this.hdlModalClose);this.$editor.unbind("keyup",
this.hdlModalClose);this.selectionRestore()},this));!1===this.isMobile()&&c(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible");return!1},modalSetTab:function(a){c(".redactor_tab").hide();c("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(a-1).addClass("redactor_tabs_act");c("#redactor_tab"+a).show()},s3handleFileSelect:function(a){a=a.target.files;for(var b=0,c;c=a[b];b++)this.s3uploadFile(c)},s3uploadFile:function(a){this.s3executeOnSignedUrl(a,
c.proxy(function(b){this.s3uploadToS3(a,b)},this))},s3executeOnSignedUrl:function(a,b){var d=new XMLHttpRequest;d.open("GET",this.opts.s3+"?name="+a.name+"&type="+a.type,!0);d.overrideMimeType("text/plain; charset=x-user-defined");d.onreadystatechange=function(){4==this.readyState&&200==this.status&&(c("#redactor-progress").fadeIn(),b(decodeURIComponent(this.responseText)))};d.send()},s3createCORSRequest:function(a,b){var c=new XMLHttpRequest;"withCredentials"in c?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?
(c=new XDomainRequest,c.open(a,b)):c=null;return c},s3uploadToS3:function(a,b){var d=this.s3createCORSRequest("PUT",b);d&&(d.onload=c.proxy(function(){if(200==d.status){c("#redactor-progress").hide();var a=b.split("?");if(!a[0])return!1;this.selectionRestore();var g="",g='<img id="image-marker" src="'+a[0]+'" />';this.opts.paragraphy&&(g="<p>"+g+"</p>");this.execCommand("inserthtml",g,!1);a=c(this.$editor.find("img#image-marker"));a.length?a.removeAttr("id"):a=!1;this.sync();this.callback("imageUpload",
a,!1);this.modalClose();this.observeImages()}},this),d.onerror=function(){},d.upload.onprogress=function(){},d.setRequestHeader("Content-Type",a.type),d.setRequestHeader("x-amz-acl","public-read"),d.send(a))},uploadInit:function(a,b){this.uploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1};c.extend(this.uploadOptions,b);var d=c("#"+a);d.length&&"INPUT"===d[0].tagName?(this.uploadOptions.input=d,this.el=c(d[0].form)):this.el=d;this.element_action=this.el.attr("action");
this.uploadOptions.auto?c(this.uploadOptions.input).change(c.proxy(function(a){this.el.submit(function(){return!1});this.uploadSubmit(a)},this)):this.uploadOptions.trigger&&c("#"+this.uploadOptions.trigger).click(c.proxy(this.uploadSubmit,this))},uploadSubmit:function(){c("#redactor-progress").fadeIn();this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(99999*Math.random());var a=this.document.createElement("div");a.innerHTML='<iframe style="display:none" id="'+
this.id+'" name="'+this.id+'"></iframe>';c(a).appendTo("body");this.uploadOptions.start&&this.uploadOptions.start();c("#"+this.id).load(c.proxy(this.uploadLoaded,this));return this.id},uploadForm:function(a,b){if(this.uploadOptions.input){var d="redactorUploadForm"+this.id,e="redactorUploadFile"+this.id;this.form=c('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+b+'" name="'+d+'" id="'+d+'" enctype="multipart/form-data" />');!1!==this.opts.uploadFields&&"object"===typeof this.opts.uploadFields&&
c.each(this.opts.uploadFields,c.proxy(function(a,b){0===b.toString().indexOf("#")&&(b=c(b).val());var d=c("<input/>",{type:"hidden",name:a,value:b});c(this.form).append(d)},this));var d=this.uploadOptions.input,g=c(d).clone();c(d).attr("id",e).before(g).appendTo(this.form);c(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body");this.form.submit()}else a.attr("target",b).attr("method","POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url),
this.element.submit()},uploadLoaded:function(){var a=c("#"+this.id)[0],a=a.contentDocument?a.contentDocument:a.contentWindow?a.contentWindow.document:window.frames[this.id].document;this.uploadOptions.success&&(c("#redactor-progress").hide(),"undefined"!==typeof a?(a=a.body.innerHTML.match(/\{(.|\n)*\}/)[0],a=a.replace(/^\[/,""),a=a.replace(/\]$/,""),a=c.parseJSON(a),"undefined"==typeof a.error?this.uploadOptions.success(a):(this.uploadOptions.error(this,a),this.modalClose())):(this.modalClose(),
alert("Upload failed!")));this.el.attr("action",this.element_action);this.el.attr("target","")},draguploadInit:function(a,b){this.draguploadOptions=c.extend({url:!1,success:!1,error:!1,preview:!1,uploadFields:!1,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose},b);if(void 0===window.FormData)return!1;this.droparea=c('<div class="redactor_droparea"></div>');this.dropareabox=c('<div class="redactor_dropareabox">'+this.draguploadOptions.text+"</div>");this.dropalternative=c('<div class="redactor_dropalternative">'+
this.draguploadOptions.atext+"</div>");this.droparea.append(this.dropareabox);c(a).before(this.droparea);c(a).before(this.dropalternative);this.dropareabox.on("dragover",c.proxy(function(){return this.draguploadOndrag()},this));this.dropareabox.on("dragleave",c.proxy(function(){return this.draguploadOndragleave()},this));this.dropareabox.get(0).ondrop=c.proxy(function(a){a.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");this.draguploadUpload(a.dataTransfer.files[0])},this)},
draguploadUpload:function(a){var b=jQuery.ajaxSettings.xhr();b.upload&&b.upload.addEventListener("progress",c.proxy(this.uploadProgress,this),!1);var d=new FormData;!1!==this.draguploadOptions.uploadFields&&"object"===typeof this.draguploadOptions.uploadFields&&c.each(this.draguploadOptions.uploadFields,c.proxy(function(a,b){0===b.toString().indexOf("#")&&(b=c(b).val());d.append(a,b)},this));d.append("file",a);c.ajax({url:this.draguploadOptions.url,dataType:"html",data:d,xhr:function(){return b},
cache:!1,contentType:!1,processData:!1,type:"POST",success:c.proxy(function(a){a=a.replace(/^\[/,"");a=a.replace(/\]$/,"");a=c.parseJSON(a);"undefined"==typeof a.error?this.draguploadOptions.success(a):(this.draguploadOptions.error(this,a),this.draguploadOptions.success(!1))},this)})},draguploadOndrag:function(){this.dropareabox.addClass("hover");return!1},draguploadOndragleave:function(){this.dropareabox.removeClass("hover");return!1},uploadProgress:function(a,b){var c=a.loaded?parseInt(100*(a.loaded/
a.total),10):a;this.dropareabox.text("Loading "+c+"% "+(b||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},outerHtml:function(a){return c("<div>").append(c(a).eq(0).clone()).html()},isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},isEmpty:function(a){a=a.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,"");a=a.replace(/\s/g,"");a=a.replace(/^<p>[^\w\d]*?<\/p>$/i,"");return""==a},browser:function(a){var b=navigator.userAgent.toLowerCase(),
b=/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||0>b.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];return"version"==a?b[2]:"webkit"==a?"chrome"==b[1]||"webkit"==b[1]:b[1]==a},oldIE:function(){return this.browser("msie")&&9>parseInt(this.browser("version"),10)?!0:!1},getFragmentHtml:function(a){a=a.cloneNode(!0);var b=this.document.createElement("div");b.appendChild(a);return b.innerHTML},
extractContent:function(){for(var a=this.$editor[0],b=this.document.createDocumentFragment(),c;c=a.firstChild;)b.appendChild(c);return b},isParentRedactor:function(a){return!a?!1:this.opts.iframe?a:0==c(a).parents("div.redactor_editor").length||c(a).hasClass("redactor_editor")?!1:a},currentOrParentIs:function(a){var b=this.getParent(),c=this.getCurrent();return b&&b.tagName===a?b:c&&c.tagName===a?c:!1},isEndOfElement:function(){var a=this.getBlock(),b=this.getCaretOffset(a),a=c.trim(c(a).text()).replace(/\n\r\n/g,
"").length;return b==a?!0:!1},isFocused:function(){var a,b=this.getSelection();b.rangeCount&&0<b.rangeCount&&(a=b.getRangeAt(0).startContainer);return!a?!1:this.opts.iframe?this.getCaretOffsetRange().equals()?!this.$editor.is(a):!0:0!=c(a).closest("div.redactor_editor").length},removeEmptyAttr:function(a,b){""==c(a).attr(b)&&c(a).removeAttr(b)},removeFromArrayByValue:function(a,b){for(var c=null;-1!==(c=a.indexOf(b));)a.splice(c,1);return a}};l.prototype.init.prototype=l.prototype;c.Redactor.fn.formatLinkify=
function(a){for(var b=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,d=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,e=(this.$editor?this.$editor.get(0):this).childNodes,g=e.length;g--;){var f=e[g];if(3===f.nodeType){var h=f.nodeValue;if(h&&(h.match(b)||h.match(d)))h=h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(b,'$1<a href="'+a+'$2">$2</a>$3').replace(d,'$1<a href="$2">$2</a>$5'),c(f).after(h).remove()}else 1===f.nodeType&&!/^(a|button|textarea)$/i.test(f.tagName)&&
c.Redactor.fn.formatLinkify.call(f,a)}}})(jQuery);
